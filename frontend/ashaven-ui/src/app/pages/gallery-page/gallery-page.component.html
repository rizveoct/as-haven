<app-gallery-hero></app-gallery-hero>

<section class="relative overflow-hidden bg-gradient-to-b from-pure via-mist to-[#f2f8ee] py-16 text-brand" id="projectGallery">
  <div class="pointer-events-none absolute -left-32 top-0 h-72 w-72 rounded-full bg-accent/25 blur-3xl md:h-96 md:w-96"></div>
  <div class="pointer-events-none absolute -bottom-24 right-[-10%] h-80 w-80 rounded-full bg-brand/25 blur-3xl md:h-[28rem] md:w-[28rem]"></div>

  <div class="relative z-10 mx-auto flex w-[min(92%,72rem)] flex-col gap-16">
    <header class="mx-auto max-w-3xl text-center">
      <span class="mb-6 inline-flex items-center justify-center gap-2 text-xs font-semibold uppercase tracking-[0.32em] text-brand/60">
        <span class="h-2 w-2 rounded-full bg-accent"></span>
        Immersive moments
      </span>
      <div class="space-y-4">
        <h2 class="font-serif text-3xl font-semibold text-brand md:text-4xl">Project Gallery</h2>
        <p class="text-base leading-relaxed text-brand/70">
          From visionary renderings to lived-in scenes, explore the curated narratives that define AS Haven. Every capture
          celebrates light, craftsmanship, and the mood of each residence.
        </p>
      </div>
      <dl class="mt-8 flex flex-wrap justify-center gap-3 text-xs font-semibold uppercase tracking-[0.24em] text-brand/60">
        <div class="flex flex-col items-center rounded-full border border-brand/15 bg-white/80 px-4 py-2 shadow-sm">
          <dt>Total</dt>
          <dd class="text-lg font-bold text-brand">{{ totalItems }}</dd>
        </div>
        <div class="flex flex-col items-center rounded-full border border-brand/15 bg-white/80 px-4 py-2 shadow-sm">
          <dt>Images</dt>
          <dd class="text-lg font-bold text-brand">{{ totalImages }}</dd>
        </div>
        <div class="flex flex-col items-center rounded-full border border-brand/15 bg-white/80 px-4 py-2 shadow-sm">
          <dt>Videos</dt>
          <dd class="text-lg font-bold text-brand">{{ totalVideos }}</dd>
        </div>
      </dl>
    </header>

    <div class="rounded-3xl border border-brand/10 bg-white/90 p-6 shadow-[0_24px_55px_rgba(32,71,38,0.12)] backdrop-blur md:p-10" role="region" aria-live="polite" aria-label="Gallery controls">
      <div class="flex flex-col gap-6">
        <div class="flex flex-wrap items-center gap-3" role="tablist" aria-label="Gallery filters">
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border px-5 py-2.5 text-sm font-semibold transition"
            [ngClass]="
              activeFilter === 'all'
                ? 'border-transparent bg-brand text-pure shadow-lg shadow-[0_18px_45px_rgba(32,71,38,0.25)]'
                : 'border-brand/20 text-brand/70 hover:-translate-y-0.5 hover:border-brand/40 hover:text-brand'
            "
            (click)="setFilter('all')"
            [attr.aria-pressed]="activeFilter === 'all'"
            role="tab"
            [attr.aria-selected]="activeFilter === 'all'"
          >
            <span class="uppercase tracking-[0.18em]">All</span>
            <span class="inline-flex h-7 min-w-[1.75rem] items-center justify-center rounded-full border border-white/40 bg-white/20 px-2 text-xs font-semibold" [ngClass]="{ 'border-brand/20 bg-white/70 text-brand': activeFilter !== 'all' }">
              {{ totalItems }}
            </span>
          </button>

          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border px-5 py-2.5 text-sm font-semibold transition"
            [ngClass]="
              activeFilter === 'image'
                ? 'border-transparent bg-brand text-pure shadow-lg shadow-[0_18px_45px_rgba(32,71,38,0.25)]'
                : 'border-brand/20 text-brand/70 hover:-translate-y-0.5 hover:border-brand/40 hover:text-brand'
            "
            (click)="setFilter('image')"
            [attr.aria-pressed]="activeFilter === 'image'"
            role="tab"
            [attr.aria-selected]="activeFilter === 'image'"
          >
            <span class="uppercase tracking-[0.18em]">Images</span>
            <span class="inline-flex h-7 min-w-[1.75rem] items-center justify-center rounded-full border border-white/40 bg-white/20 px-2 text-xs font-semibold" [ngClass]="{ 'border-brand/20 bg-white/70 text-brand': activeFilter !== 'image' }">
              {{ totalImages }}
            </span>
          </button>

          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border px-5 py-2.5 text-sm font-semibold transition"
            [ngClass]="
              activeFilter === 'video'
                ? 'border-transparent bg-brand text-pure shadow-lg shadow-[0_18px_45px_rgba(32,71,38,0.25)]'
                : 'border-brand/20 text-brand/70 hover:-translate-y-0.5 hover:border-brand/40 hover:text-brand'
            "
            (click)="setFilter('video')"
            [attr.aria-pressed]="activeFilter === 'video'"
            role="tab"
            [attr.aria-selected]="activeFilter === 'video'"
          >
            <span class="uppercase tracking-[0.18em]">Videos</span>
            <span class="inline-flex h-7 min-w-[1.75rem] items-center justify-center rounded-full border border-white/40 bg-white/20 px-2 text-xs font-semibold" [ngClass]="{ 'border-brand/20 bg-white/70 text-brand': activeFilter !== 'video' }">
              {{ totalVideos }}
            </span>
          </button>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-4">
          <span *ngIf="!isLoading && !loadError" class="inline-flex items-center gap-2 text-sm font-medium text-brand/70">
            <span class="h-2 w-2 animate-pulse rounded-full bg-accent"></span>
            {{ filteredGalleryItems.length }}
            {{ activeFilter === 'video' ? 'videos' : activeFilter === 'image' ? 'photos' : 'items' }}
          </span>
          <button type="button" (click)="loadGalleryItems()" class="inline-flex items-center gap-2 rounded-full border border-brand/20 px-4 py-2 text-sm font-semibold text-brand/70 transition hover:border-brand hover:text-brand">
            <i class="ri-refresh-line" aria-hidden="true"></i>
            Refresh
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="loadError" class="mx-auto w-full max-w-xl rounded-3xl border border-dashed border-accent/40 bg-white/90 p-8 text-center text-brand">
      <h3 class="font-semibold text-brand">We couldn't load the gallery.</h3>
      <p class="mt-3 text-sm text-brand/70">
        Please check your connection and try again. The curated visuals will be right back.
      </p>
      <button type="button" (click)="loadGalleryItems()" class="mt-4 inline-flex items-center gap-2 rounded-full bg-accent px-5 py-2.5 text-sm font-semibold text-pure shadow-lg shadow-[0_18px_45px_rgba(255,119,27,0.35)] transition hover:-translate-y-0.5 hover:bg-orange-500">
        Try again
      </button>
    </div>

    <ng-container *ngIf="isLoading; else galleryContent">
      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
        <div class="h-64 animate-pulse rounded-3xl bg-brand/10" *ngFor="let _ of skeletonPlaceholders"></div>
      </div>
    </ng-container>

    <ng-template #galleryContent>
      <ng-container *ngIf="filteredGalleryItems.length; else emptyGallery">
        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3" role="list">
          <button
            type="button"
            class="group relative overflow-hidden rounded-3xl border border-brand/10 bg-white shadow-[0_18px_45px_rgba(32,71,38,0.12)] transition hover:-translate-y-1 hover:shadow-[0_30px_70px_rgba(32,71,38,0.16)]"
            *ngFor="let item of filteredGalleryItems; trackBy: trackById"
            (click)="openItem(item)"
            [attr.aria-label]="getAriaLabel(item)"
            role="listitem"
          >
            <span class="block overflow-hidden">
              <img
                *ngIf="isImage(item)"
                [src]="mediaUrl(item)"
                [alt]="item.title || 'Gallery image'"
                loading="lazy"
                class="h-64 w-full object-cover transition duration-500 group-hover:scale-105"
                (error)="onImageError($event)"
              />
              <video
                *ngIf="isVideo(item)"
                [src]="mediaUrl(item)"
                muted
                loop
                playsinline
                preload="metadata"
                class="h-64 w-full object-cover transition duration-500 group-hover:scale-105"
                (error)="onImageError($event)"
              ></video>
            </span>

            <span class="absolute inset-x-0 bottom-0 flex items-center justify-between gap-4 bg-gradient-to-t from-black/70 via-black/30 to-transparent px-5 py-4 text-left text-pure">
              <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold" [ngClass]="isVideo(item) ? 'bg-accent/30 text-accent' : 'bg-white/20 text-pure'">
                <i class="ri-camera-3-line" *ngIf="!isVideo(item)" aria-hidden="true"></i>
                <i class="ri-play-circle-line" *ngIf="isVideo(item)" aria-hidden="true"></i>
                {{ isVideo(item) ? 'Video' : 'Photo' }}
              </span>
              <span class="text-sm font-semibold">{{ item.title || 'Untitled item' }}</span>
            </span>
          </button>
        </div>
      </ng-container>
    </ng-template>
  </div>
</section>

<ng-template #emptyGallery>
  <div class="mx-auto w-[min(90%,40rem)] rounded-3xl border border-dashed border-brand/15 bg-white/80 p-10 text-center text-brand/70">
    <span class="text-xs font-semibold uppercase tracking-[0.32em] text-brand/60">Gallery coming soon</span>
    <p class="mt-4 font-serif text-2xl text-brand">We are curating something special.</p>
    <p class="mt-2 text-sm">
      Our creative team is capturing new moments from the latest residences. Check back shortly to experience the next chapter of AS Haven.
    </p>
  </div>
</ng-template>

<div
  *ngIf="lightboxOpen && currentItem"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur"
  (touchstart)="onTouchStart($event)"
  (touchend)="onTouchEnd($event)"
>
  <div class="relative mx-4 w-full max-w-4xl rounded-3xl bg-black/80 p-6 shadow-[0_24px_60px_rgba(0,0,0,0.45)]">
    <button class="absolute right-4 top-4 text-3xl text-white/70 transition hover:text-white" (click)="closeLightbox()" aria-label="Close lightbox">
      <span aria-hidden="true">×</span>
    </button>

    <ng-container *ngIf="currentItem">
      <img
        *ngIf="isImage(currentItem)"
        [src]="mediaUrl(currentItem)"
        [alt]="currentItem.title || 'Gallery image'"
        class="max-h-[70vh] w-full rounded-2xl object-contain"
        (error)="onImageError($event)"
      />

      <video
        *ngIf="isVideo(currentItem)"
        [src]="mediaUrl(currentItem)"
        controls
        autoplay
        playsinline
        class="max-h-[70vh] w-full rounded-2xl object-contain"
        (error)="onImageError($event)"
      ></video>
    </ng-container>

    <button class="absolute left-4 top-1/2 -translate-y-1/2 rounded-full bg-white/10 p-3 text-white transition hover:bg-white/20" (click)="prevItem($event)" aria-label="Previous item">
      <i class="ri-arrow-left-s-line" aria-hidden="true"></i>
    </button>
    <button class="absolute right-4 top-1/2 -translate-y-1/2 rounded-full bg-white/10 p-3 text-white transition hover:bg-white/20" (click)="nextItem($event)" aria-label="Next item">
      <i class="ri-arrow-right-s-line" aria-hidden="true"></i>
    </button>
  </div>
</div>
