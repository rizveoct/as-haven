<app-gallery-hero></app-gallery-hero>

<section class="gallery-section" id="projectGallery">
  <div class="gallery-section__aurora"></div>
  <div class="gallery-section__aurora gallery-section__aurora--right"></div>

  <div class="gallery-section__container">
    <div class="gallery-section__intro fade-up">
      <span class="gallery-section__eyebrow">Immersive Moments</span>
      <div class="gallery-section__heading">
        <h2 class="gallery-section__title">Project Gallery</h2>
        <p class="gallery-section__description">
          From visionary renderings to lived-in scenes, explore the curated
          narratives that define AS Haven. Every capture celebrates light,
          craftsmanship, and the mood of each residence.
        </p>
      </div>

      <div class="gallery-app__counts" aria-label="Gallery totals">
        <div class="gallery-app__count">
          <span class="gallery-app__count-value">{{ totalItems }}</span>
          <span class="gallery-app__count-label">Total</span>
        </div>
        <div class="gallery-app__count">
          <span class="gallery-app__count-value">{{ totalImages }}</span>
          <span class="gallery-app__count-label">Images</span>
        </div>
        <div class="gallery-app__count">
          <span class="gallery-app__count-value">{{ totalVideos }}</span>
          <span class="gallery-app__count-label">Videos</span>
        </div>
      </div>
    </div> <!-- FIX: was </header> -->
    <!-- ^ closing the .gallery-section__intro div properly -->

    <div class="gallery-section__panel fade-up" role="region" aria-live="polite">
      <div class="gallery-section__panel-content">
        <div class="gallery-section__filters" role="tablist" aria-label="Gallery filters">
          <button
            type="button"
            class="gallery-filter"
            [class.is-active]="activeFilter === 'all'"
            (click)="setFilter('all')"
            [attr.aria-pressed]="activeFilter === 'all'"
            role="tab"
            [attr.aria-selected]="activeFilter === 'all'">
            All
            <span class="gallery-filter__count">{{ totalItems }}</span>
          </button>

          <button
            type="button"
            class="gallery-filter"
            [class.is-active]="activeFilter === 'image'"
            (click)="setFilter('image')"
            [attr.aria-pressed]="activeFilter === 'image'"
            role="tab"
            [attr.aria-selected]="activeFilter === 'image'">
            Images
            <span class="gallery-filter__count">{{ totalImages }}</span>
          </button>

          <button
            type="button"
            class="gallery-filter"
            [class.is-active]="activeFilter === 'video'"
            (click)="setFilter('video')"
            [attr.aria-pressed]="activeFilter === 'video'"
            role="tab"
            [attr.aria-selected]="activeFilter === 'video'">
            Videos
            <span class="gallery-filter__count">{{ totalVideos }}</span>
          </button>
        </div>

        <div class="gallery-section__panel-actions">
          <span *ngIf="!isLoading && !loadError" class="gallery-section__panel-status">
            <span class="gallery-section__panel-dot" aria-hidden="true"></span>
            {{ filteredGalleryItems.length }} curated
            {{ activeFilter === 'video' ? 'reels' : activeFilter === 'image' ? 'stills' : 'stories' }}
          </span>
          <button class="gallery-section__refresh" type="button" (click)="loadGalleryItems()">
            <span class="gallery-section__refresh-icon" aria-hidden="true">⟲</span>
            Refresh
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="loadError" class="gallery-error fade-up" role="alert">
      <div class="gallery-error__card">
        <h3 class="gallery-error__title">We couldn't load the gallery.</h3>
        <p class="gallery-error__copy">
          Please check your connection and try again. The curated visuals will
          be right back.
        </p>
        <button class="gallery-error__retry" type="button" (click)="loadGalleryItems()">
          Try again
        </button>
      </div>
    </div>

    <ng-container *ngIf="isLoading; else galleryContent">
      <div class="gallery-skeleton fade-up" aria-hidden="true">
        <div class="gallery-skeleton__card gallery-skeleton__card--hero"></div>
        <div class="gallery-skeleton__grid">
          <div
            class="gallery-skeleton__card"
            *ngFor="let placeholder of skeletonPlaceholders; index as i"
            [class.gallery-skeleton__card--tall]="i % 3 === 0">
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #galleryContent>
      <ng-container *ngIf="filteredGalleryItems.length; else emptyGallery">
        <div class="gallery-section__grid fade-up">
          <ng-container *ngIf="featuredItem as hero">
            <button
              type="button"
              class="gallery-card gallery-card--featured"
              (click)="openItem(hero)"
              [attr.aria-label]="getAriaLabel(hero)">
              <span class="gallery-card__media">
                <img
                  *ngIf="isImage(hero)"
                  [src]="mediaUrl(hero)"
                  [alt]="hero.title || 'Gallery image'"
                  loading="lazy"
                  class="gallery-card__media-el"
                  (error)="onImageError($event)" />
                <video
                  *ngIf="isVideo(hero)"
                  [src]="mediaUrl(hero)"
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  class="gallery-card__media-el"
                  (error)="onImageError($event)"></video>
              </span>

              <span class="gallery-card__overlay">
                <span class="gallery-card__chip" [class.is-video]="isVideo(hero)">
                  {{ isVideo(hero) ? 'Video' : 'Image' }}
                </span>
                <span class="gallery-card__title">
                  {{ hero.title || 'Untitled showcase' }}
                </span>
                <span *ngIf="hero.description" class="gallery-card__description">
                  {{ hero.description }}
                </span>
                <span class="gallery-card__cta">
                  {{ isVideo(hero) ? 'Watch reel' : 'View still' }}
                </span>
              </span>
            </button>
          </ng-container>

          <div class="gallery-section__grid-inner">
            <button
              type="button"
              class="gallery-card"
              *ngFor="let item of supportingItems; trackBy: trackById"
              (click)="openItem(item)"
              [attr.aria-label]="getAriaLabel(item)">
              <span class="gallery-card__media">
                <img
                  *ngIf="isImage(item)"
                  [src]="mediaUrl(item)"
                  [alt]="item.title || 'Gallery image'"
                  loading="lazy"
                  class="gallery-card__media-el"
                  (error)="onImageError($event)" />
                <video
                  *ngIf="isVideo(item)"
                  [src]="mediaUrl(item)"
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  class="gallery-card__media-el"
                  (error)="onImageError($event)"></video>
              </span>

              <span class="gallery-card__overlay">
                <span class="gallery-card__chip" [class.is-video]="isVideo(item)">
                  {{ isVideo(item) ? 'Video' : 'Image' }}
                </span>
                <span class="gallery-card__title">
                  {{ item.title || 'Untitled showcase' }}
                </span>
                <span *ngIf="item.description" class="gallery-card__description">
                  {{ item.description }}
                </span>
                <span class="gallery-card__cta">
                  {{ isVideo(item) ? 'Watch reel' : 'View still' }}
                </span>
              </span>
            </button>
          </div>
        </div>
      </ng-container>
    </ng-template>
  </div>
</section>

<ng-template #emptyGallery>
  <div class="gallery-empty fade-up">
    <div class="gallery-empty__card">
      <span class="gallery-empty__eyebrow">Gallery coming soon</span>
      <p class="gallery-empty__title">We are curating something special.</p>
      <p class="gallery-empty__copy">
        Our creative team is capturing new moments from the latest residences. Check back shortly to experience the next chapter of AS Haven.
      </p>
    </div>
  </div>
</ng-template>

<!-- Lightbox Modal -->
<div
  *ngIf="lightboxOpen && currentItem"
  class="gallery-lightbox"
  (touchstart)="onTouchStart($event)"
  (touchend)="onTouchEnd($event)">
  <div class="gallery-lightbox__content">
    <button class="gallery-lightbox__close" (click)="closeLightbox()" aria-label="Close lightbox">
      <span aria-hidden="true">×</span>
    </button>

    <ng-container *ngIf="currentItem">
      <img
        *ngIf="isImage(currentItem)"
        [src]="mediaUrl(currentItem)"
        [alt]="currentItem.title || 'Gallery image'"
        class="gallery-lightbox__media"
        (error)="onImageError($event)" />

      <video
        *ngIf="isVideo(currentItem)"
        [src]="mediaUrl(currentItem)"
        controls
        autoplay
        playsinline
        class="gallery-lightbox__media"
        (error)="onImageError($event)"></video>
    </ng-container>

    <button class="gallery-lightbox__nav gallery-lightbox__nav--prev" (click)="prevItem($event)" aria-label="Previous item">❮</button>
    <button class="gallery-lightbox__nav gallery-lightbox__nav--next" (click)="nextItem($event)" aria-label="Next item">❯</button>
  </div>
</div>
